import { useEffect, useMemo, useState } from "react";

/** ---------- Types ---------- */

type ServiceModel = "iaas" | "paas" | "saas";
type DeploymentModel = "public" | "private" | "hybrid";

interface Part5CloudDesignerProps {
  onComplete: (score: number) => void;
}

interface Scenario {
  id: number;
  title: string;
  description: string;
  minUsers: number;
  maxUsers: number;
  defaultUsers: number;

  /** Relative importance of each dimension (weights must sum ~1) */
  weights: {
    cost: number;
    performance: number;   // scale/elasticity
    compliance: number;    // compliance/control
    effort: number;        // ease of operations (lower effort = better)
  };

  /**
   * The combinations we expect to be particularly strong for teaching purposes.
   * Used to award points (but learners will also see the transparent ranking).
   */
  idealCombos: Array<{ service: ServiceModel; deployment: DeploymentModel }>;

  /** Optional: if SaaS is conceptually "not applicable" for the scenario. */
  saasApplicable?: boolean;
}

/** ---------- Model metadata (simple but more faithful) ---------- */

const SERVICE_META: Record<
  ServiceModel,
  {
    label: string;
    blurb: string;
    monthlyOpsOverhead: number; // simple proxy for platform/ops cost
    controlBonus: number;       // influences compliance/control
    lockInRisk: "low" | "med" | "high";
    effortScore: number;        // 0..100 (higher = more effort); we invert to get "ease"
  }
> = {
  iaas: {
    label: "IaaS (build & run VMs/containers)",
    blurb:
      "You manage OS/runtime and scaling. Highest control and flexibility; slower to ship; more ops work.",
    monthlyOpsOverhead: 6000,
    controlBonus: +8,
    lockInRisk: "low",
    effortScore: 75,
  },
  paas: {
    label: "PaaS (managed app platform)",
    blurb:
      "You push code; platform handles runtime, scaling, and much of ops. Good balance of speed and control.",
    monthlyOpsOverhead: 2500,
    controlBonus: +2,
    lockInRisk: "med",
    effortScore: 45,
  },
  saas: {
    label: "SaaS (use an existing product)",
    blurb:
      "You subscribe to software someone else runs. Fastest time‚Äëto‚Äëvalue; least control/customization.",
    monthlyOpsOverhead: 800, // admin/config, integrations
    controlBonus: -6,
    lockInRisk: "high",
    effortScore: 20,
  },
};

const DEPLOYMENT_META: Record<
  DeploymentModel,
  {
    label: string;
    blurb: string;
    fixedInfra: number;        // base monthly infra (e.g., private DC amortized)
    variablePerKUsers: number; // $ per 1,000 users per month
    elasticity: number;        // 0..100 (scale burstiness)
    baseCompliance: number;    // 0..100 (control/compliance posture)
  }
> = {
  public: {
    label: "Public Cloud",
    blurb:
      "Elastic capacity with pay‚Äëas‚Äëyou‚Äëgo. Great for spiky workloads and faster global reach.",
    fixedInfra: 0,
    variablePerKUsers: 180,
    elasticity: 90,
    baseCompliance: 70,
  },
  private: {
    label: "Private Cloud / On‚ÄëPrem",
    blurb:
      "Dedicated resources and higher control. Good for strict compliance; capacity must be planned.",
    fixedInfra: 12000,
    variablePerKUsers: 60,
    elasticity: 55,
    baseCompliance: 90,
  },
  hybrid: {
    label: "Hybrid",
    blurb:
      "Mix of private plus public burst. Strikes a balance: control where needed, elasticity for peaks.",
    fixedInfra: 4000,
    variablePerKUsers: 110,
    elasticity: 80,
    baseCompliance: 85,
  },
};

/** ---------- Scenarios (beginner friendly) ---------- */

const SCENARIOS: Scenario[] = [
  {
    id: 1,
    title: "Viral Mobile App Launch",
    description:
      "You‚Äôre a small team launching a new consumer app. User growth is uncertain and potentially spiky. You need to ship fast and keep costs sensible at low/medium scale.",
    minUsers: 1_000,
    maxUsers: 200_000,
    defaultUsers: 15_000,
    weights: {
      cost: 0.30,
      performance: 0.35,
      compliance: 0.10,
      effort: 0.25,
    },
    idealCombos: [
      { service: "paas", deployment: "public" },
      { service: "iaas", deployment: "public" },
    ],
    saasApplicable: false,
  },
  {
    id: 2,
    title: "Hospital Patient Portal (PHI)",
    description:
      "A healthcare provider needs to store and process PHI. Compliance and control matter most, but the portal must still scale during seasonal surges.",
    minUsers: 5_000,
    maxUsers: 100_000,
    defaultUsers: 25_000,
    weights: {
      cost: 0.15,
      performance: 0.25,
      compliance: 0.45,
      effort: 0.15,
    },
    idealCombos: [
      { service: "iaas", deployment: "hybrid" },
      { service: "iaas", deployment: "private" },
      { service: "paas", deployment: "hybrid" },
    ],
    saasApplicable: false,
  },
  {
    id: 3,
    title: "Internal CRM for a Sales Team",
    description:
      "You need CRM functionality for ~500‚Äì5,000 employees. Time‚Äëto‚Äëvalue and reliability are key; deep customization is less important than getting a proven system.",
    minUsers: 500,
    maxUsers: 10_000,
    defaultUsers: 3_000,
    weights: {
      cost: 0.30,
      performance: 0.20,
      compliance: 0.20,
      effort: 0.30,
    },
    idealCombos: [{ service: "saas", deployment: "public" }],
    saasApplicable: true,
  },
];

/** ---------- Helpers ---------- */

function clamp(n: number, lo: number, hi: number) {
  return Math.max(lo, Math.min(hi, n));
}

function dollars(n: number) {
  return `$${Math.round(n).toLocaleString()}/mo`;
}

function normalizeTo0_100(values: number[], value: number) {
  const min = Math.min(...values);
  const max = Math.max(...values);
  if (Math.abs(max - min) < 1e-6) return 50; // avoid divide-by-zero: flat field
  return clamp(((max - value) / (max - min)) * 100, 0, 100); // lower $ => higher score
}

type Metrics = {
  cost: number;         // $/mo
  performance: number;  // 0..100
  compliance: number;   // 0..100
  ease: number;         // 0..100 (higher = less effort)
  fit: number;          // 0..100 weighted by scenario
  explain: string[];    // bullet points explaining the result
};

function computeMetrics(
  service: ServiceModel,
  deployment: DeploymentModel,
  users: number,
  scenario: Scenario
): Metrics {
  const s = SERVICE_META[service];
  const d = DEPLOYMENT_META[deployment];

  // --- Cost model (infra + platform/ops) ---
  const infraCost = d.fixedInfra + (users / 1000) * d.variablePerKUsers;
  const platformOpsCost = s.monthlyOpsOverhead;
  const cost = infraCost + platformOpsCost;

  // --- Performance / Scale (based on elasticity & load vs "headroom") ---
  // Treat scenario.maxUsers as "peak planning horizon" learners can imagine.
  // Private clouds lose performance if you push close to that ceiling; public handles spikes better.
  const loadFactor = clamp(users / scenario.maxUsers, 0, 1);
  let perf = d.elasticity - (deployment === "private" ? loadFactor * 25 : loadFactor * 8);
  // PaaS tends to add autoscaling and platform tuning benefits
  if (service === "paas") perf += 5;
  perf = clamp(perf, 25, 98);

  // --- Compliance & Control (deployment posture + service control bonus) ---
  let compliance = d.baseCompliance + s.controlBonus;
  // SaaS reduces customization/control; in PHI-like scenarios, highlight that subtly
  if (service === "saas" && !scenario.saasApplicable) compliance -= 10;
  compliance = clamp(compliance, 40, 98);

  // --- Operational effort (invert the service effort score; hybrid adds some integration tax) ---
  let ease = clamp(100 - s.effortScore - (deployment === "hybrid" ? 6 : 0), 10, 95);

  const explain: string[] = [
    `Cost combines ${d.label.toLowerCase()} infra ${dollars(infraCost)} + ${s.label.split(" ")[0]} platform/ops ${dollars(platformOpsCost)}.`,
    `${d.label} elasticity (${d.elasticity}/100) ${deployment === "private" ? "drops more near peak without capacity planning" : "handles spikes better"}, so at ${Math.round(loadFactor * 100)}% of peak your performance score is ${Math.round(perf)}.`,
    `Compliance/control is influenced by ${d.label} (${d.baseCompliance}/100) and ${s.label.split(" ")[0]} control bonus (${s.controlBonus >= 0 ? "+" : ""}${s.controlBonus}).`,
    `Operational effort is mostly driven by the service model; ${s.label.split(" ")[0]} implies ${100 - ease}/100 effort (lower ease).${deployment === "hybrid" ? " Hybrid adds some integration overhead." : ""}`,
  ];

  return { cost, performance: perf, compliance, ease, fit: 0, explain };
}

function weightedFit(
  m: Metrics,
  peerCosts: number[],
  weights: Scenario["weights"]
): { fit: number; affordability: number } {
  const affordability = normalizeTo0_100(peerCosts, m.cost); // 100 is cheapest
  const fit =
    weights.cost * affordability +
    weights.performance * m.performance +
    weights.compliance * m.compliance +
    weights.effort * m.ease;

  return { fit: Math.round(fit), affordability: Math.round(affordability) };
}

/** ---------- Main Component ---------- */

export default function Part5CloudDesignerV2({ onComplete }: Part5CloudDesignerProps) {
  const [scenarioIdx, setScenarioIdx] = useState(0);
  const [service, setService] = useState<ServiceModel | null>(null);
  const [deployment, setDeployment] = useState<DeploymentModel | null>(null);
  const [users, setUsers] = useState(SCENARIOS[0].defaultUsers);
  const [evaluated, setEvaluated] = useState(false);
  const [totalScore, setTotalScore] = useState(0);
  const [showCompare, setShowCompare] = useState(true);

  const scenario = SCENARIOS[scenarioIdx];

  useEffect(() => {
    setService(null);
    setDeployment(null);
    setUsers(scenario.defaultUsers);
    setEvaluated(false);
    setShowCompare(true);
  }, [scenarioIdx, scenario.defaultUsers]);

  // Pre-compute all combos for comparison
  const allCombos = useMemo(() => {
    const services: ServiceModel[] = ["iaas", "paas", "saas"];
    const deployments: DeploymentModel[] = ["public", "private", "hybrid"];

    const combos = services.flatMap((s) =>
      deployments.map((d) => ({
        service: s,
        deployment: d,
        metrics: computeMetrics(s, d, users, scenario),
      }))
    );

    const peerCosts = combos.map((c) => c.metrics.cost);
    const withFit = combos.map((c) => {
      const { fit, affordability } = weightedFit(c.metrics, peerCosts, scenario.weights);
      return { ...c, metrics: { ...c.metrics, fit, explain: c.metrics.explain } as Metrics, affordability };
    });

    // Sort by fit descending
    withFit.sort((a, b) => b.metrics.fit - a.metrics.fit);
    return withFit;
  }, [users, scenario]);

  const selected =
    service && deployment
      ? allCombos.find((c) => c.service === service && c.deployment === deployment)
      : null;

  const topFit = allCombos[0];

  const handleEvaluate = () => {
    if (!selected) return;
    setEvaluated(true);

    // Award points: exact top = +7, within top 3 = +5, else +3
    const rank = allCombos.findIndex(
      (c) => c.service === selected.service && c.deployment === selected.deployment
    );
    const basePoints = rank === 0 ? 7 : rank <= 2 ? 5 : 3;

    // Bonus if the selection matches one of the scenario's pedagogical "ideal" combos
    const matchesIdeal = scenario.idealCombos.some(
      (x) => x.service === selected.service && x.deployment === selected.deployment
    );
    const points = basePoints + (matchesIdeal ? 1 : 0);

    setTotalScore((p) => p + points);
  };

  const handleNext = () => {
    if (scenarioIdx < SCENARIOS.length - 1) {
      setScenarioIdx((i) => i + 1);
    } else {
      onComplete(totalScore);
    }
  };

  // Helpers for UI
  const Bar = ({ value, label }: { value: number; label: string }) => (
    <div className="mb-3">
      <div className="flex justify-between text-sm text-slate-300"><span>{label}</span><span>{Math.round(value)}/100</span></div>
      <div className="w-full h-2 bg-slate-700 rounded">
        <div className="h-2 rounded bg-cyan-500" style={{ width: `${clamp(value, 0, 100)}%` }} />
      </div>
    </div>
  );

  const Pill = ({ text }: { text: string }) => (
    <span className="text-xs bg-slate-700 text-slate-200 px-2 py-1 rounded-full border border-slate-600">{text}</span>
  );

  return (
    <div className="min-h-screen bg-gradient-to-br from-slate-900 via-indigo-900 to-slate-900 flex items-center justify-center p-4">
      <div className="max-w-6xl w-full bg-slate-800/50 backdrop-blur-sm rounded-2xl p-6 md:p-8 shadow-2xl border border-indigo-500/20">
        {/* Title */}
        <h1 className="text-3xl md:text-4xl font-bold text-white text-center mb-2">Cloud Design Activity</h1>
        <p className="text-slate-300 text-center mb-6">
          Choose a <b>service model</b> and a <b>deployment model</b> for each scenario. Adjust the users to see trade‚Äëoffs. Then evaluate your pick.
        </p>

        {/* Scenario card */}
        <div className="bg-slate-900/50 rounded-xl p-5 mb-6">
          <div className="flex flex-wrap items-center justify-between gap-2 mb-2">
            <p className="text-cyan-400 font-semibold">Scenario {scenarioIdx + 1} of {SCENARIOS.length}</p>
            <div className="flex gap-2">
              <Pill text={`Users: ${users.toLocaleString()}`} />
              <Pill text={`Weights ‚Üí Cost ${Math.round(scenario.weights.cost*100)}%, Perf ${Math.round(scenario.weights.performance*100)}%, Compliance ${Math.round(scenario.weights.compliance*100)}%, Effort ${Math.round(scenario.weights.effort*100)}%`} />
            </div>
          </div>
          <h2 className="text-2xl font-bold text-white mb-1">{scenario.title}</h2>
          <p className="text-slate-300">{scenario.description}</p>
        </div>

        {/* Controls */}
        <div className="grid md:grid-cols-3 gap-6 mb-6">
          {/* Service selection */}
          <div className="bg-slate-900/50 rounded-xl p-5">
            <p className="text-white font-semibold mb-3">1) Choose a Service Model</p>
            {(["iaas", "paas", "saas"] as ServiceModel[]).map((m) => {
              const meta = SERVICE_META[m];
              const disabled = m === "saas" && scenario.saasApplicable === false;
              return (
                <button
                  key={m}
                  disabled={disabled}
                  onClick={() => setService(m)}
                  className={`w-full text-left p-3 rounded-lg mb-2 border transition
                    ${service === m ? "border-cyan-400 bg-slate-800" : "border-slate-700 bg-slate-800/60 hover:bg-slate-800"}
                    ${disabled ? "opacity-50 cursor-not-allowed" : ""}`}
                  aria-pressed={service === m}
                  aria-label={meta.label}
                >
                  <div className="text-slate-100 font-semibold">{meta.label}</div>
                  <div className="text-slate-400 text-sm">{meta.blurb}</div>
                  <div className="flex gap-2 mt-2">
                    <Pill text={`Ops overhead: ${dollars(meta.monthlyOpsOverhead)}`} />
                    <Pill text={`Lock‚Äëin: ${meta.lockInRisk}`} />
                  </div>
                </button>
              );
            })}
          </div>

          {/* Deployment selection */}
          <div className="bg-slate-900/50 rounded-xl p-5">
            <p className="text-white font-semibold mb-3">2) Choose a Deployment Model</p>
            {(["public", "private", "hybrid"] as DeploymentModel[]).map((m) => {
              const meta = DEPLOYMENT_META[m];
              return (
                <button
                  key={m}
                  onClick={() => setDeployment(m)}
                  className={`w-full text-left p-3 rounded-lg mb-2 border transition
                    ${deployment === m ? "border-blue-400 bg-slate-800" : "border-slate-700 bg-slate-800/60 hover:bg-slate-800"}`}
                  aria-pressed={deployment === m}
                  aria-label={meta.label}
                >
                  <div className="text-slate-100 font-semibold">{meta.label}</div>
                  <div className="text-slate-400 text-sm">{meta.blurb}</div>
                  <div className="flex gap-2 mt-2">
                    <Pill text={`Fixed: ${dollars(meta.fixedInfra)}`} />
                    <Pill text={`+ $${meta.variablePerKUsers}/1k users`} />
                    <Pill text={`Elasticity ${meta.elasticity}/100`} />
                  </div>
                </button>
              );
            })}
          </div>

          {/* Users slider */}
          <div className="bg-slate-900/50 rounded-xl p-5">
            <p className="text-white font-semibold mb-3">3) Adjust Scale</p>
            <div className="text-slate-300 mb-2">Active users: <b>{users.toLocaleString()}</b></div>
            <input
              type="range"
              min={scenario.minUsers}
              max={scenario.maxUsers}
              step={Math.max(100, Math.round((scenario.maxUsers - scenario.minUsers) / 100))}
              value={users}
              onChange={(e) => setUsers(Number(e.target.value))}
              className="w-full h-2 bg-slate-700 rounded-lg appearance-none accent-cyan-500"
              aria-label="Active users"
            />
            <div className="flex justify-between text-slate-400 text-xs mt-1">
              <span>{scenario.minUsers.toLocaleString()}</span>
              <span>{scenario.maxUsers.toLocaleString()}</span>
            </div>
          </div>
        </div>

        {/* Metrics panel */}
        <div className="bg-slate-900/50 rounded-xl p-5 mb-4">
          <div className="flex items-center justify-between gap-2 mb-3">
            <p className="text-white font-semibold">4) See Trade‚Äëoffs</p>
            <button
              className="text-xs px-3 py-1 rounded border border-slate-600 text-slate-200 hover:bg-slate-800"
              onClick={() => setShowCompare((s) => !s)}
            >
              {showCompare ? "Hide" : "Show"} compare‚Äëall table
            </button>
          </div>

          {selected ? (
            <div className="grid md:grid-cols-2 gap-6">
              {/* Selected metrics */}
              <div>
                <div className="text-slate-200 font-semibold mb-1">
                  Your selection: <span className="text-cyan-300">{SERVICE_META[selected.service].label}</span> +{" "}
                  <span className="text-blue-300">{DEPLOYMENT_META[selected.deployment].label}</span>
                </div>
                <div className="text-slate-400 text-sm mb-2">
                  Estimated monthly cost: <b className="text-cyan-300">{dollars(selected.metrics.cost)}</b>
                </div>
                <Bar value={selected.metrics.performance} label="Scale & Performance" />
                <Bar value={selected.metrics.compliance} label="Compliance & Control" />
                <Bar value={selected.metrics.ease} label="Ease of Operations" />

                <div className="mt-3 text-slate-300 text-sm">
                  <div className="font-semibold mb-1">Why it scores this way:</div>
                  <ul className="list-disc ml-5 space-y-1">
                    {selected.metrics.explain.map((x, i) => (
                      <li key={i}>{x}</li>
                    ))}
                  </ul>
                </div>

                <div className="mt-4 text-slate-200">
                  <span className="mr-2">Fit Score (weighted for this scenario):</span>
                  <span className="text-xl font-bold text-emerald-400">{selected.metrics.fit}/100</span>
                </div>
              </div>

              {/* Top recommendation */}
              <div className="bg-slate-800/40 rounded-lg p-4 border border-emerald-500/30">
                <div className="flex items-center justify-between">
                  <div className="text-slate-200 font-semibold">Top recommended option</div>
                  <span className="text-xs text-emerald-300 bg-emerald-900/30 border border-emerald-700 px-2 py-0.5 rounded">
                    Highest Fit Score
                  </span>
                </div>
                <div className="mt-2 text-slate-200">
                  <div>
                    <span className="text-emerald-300">{SERVICE_META[topFit.service].label}</span> +{" "}
                    <span className="text-emerald-300">{DEPLOYMENT_META[topFit.deployment].label}</span>
                  </div>
                  <div className="text-slate-400 text-sm">
                    Cost: <b className="text-cyan-300">{dollars(topFit.metrics.cost)}</b> ¬∑ Fit:{" "}
                    <b className="text-emerald-300">{topFit.metrics.fit}/100</b>
                  </div>
                  <div className="mt-2">
                    <Bar value={topFit.metrics.performance} label="Scale & Performance" />
                    <Bar value={topFit.metrics.compliance} label="Compliance & Control" />
                    <Bar value={topFit.metrics.ease} label="Ease of Operations" />
                  </div>
                </div>
              </div>
            </div>
          ) : (
            <p className="text-slate-300">Choose a service model and a deployment model to see detailed trade‚Äëoffs.</p>
          )}

          {/* Compare-all table */}
          {showCompare && (
            <div className="mt-6 overflow-x-auto">
              <table className="w-full text-sm">
                <thead className="text-slate-300">
                  <tr className="text-left">
                    <th className="py-2 pr-3">Rank</th>
                    <th className="py-2 pr-3">Option</th>
                    <th className="py-2 pr-3">Cost</th>
                    <th className="py-2 pr-3">Perf</th>
                    <th className="py-2 pr-3">Compliance</th>
                    <th className="py-2 pr-3">Ease</th>
                    <th className="py-2 pr-3">Fit</th>
                  </tr>
                </thead>
                <tbody className="text-slate-200">
                  {allCombos.map((c, i) => (
                    <tr
                      key={`${c.service}-${c.deployment}`}
                      className={`border-t border-slate-700/50 ${selected && c.service === selected.service && c.deployment === selected.deployment ? "bg-slate-800/60" : ""}`}
                    >
                      <td className="py-2 pr-3 text-slate-400">{i + 1}</td>
                      <td className="py-2 pr-3">
                        <div className="font-medium">{SERVICE_META[c.service].label}</div>
                        <div className="text-slate-400 text-xs">{DEPLOYMENT_META[c.deployment].label}</div>
                      </td>
                      <td className="py-2 pr-3">{dollars(c.metrics.cost)}</td>
                      <td className="py-2 pr-3">{Math.round(c.metrics.performance)}</td>
                      <td className="py-2 pr-3">{Math.round(c.metrics.compliance)}</td>
                      <td className="py-2 pr-3">{Math.round(c.metrics.ease)}</td>
                      <td className="py-2 pr-3 font-semibold">{c.metrics.fit}</td>
                    </tr>
                  ))}
                </tbody>
              </table>
              <div className="text-xs text-slate-400 mt-2">
                Fit = weighted combination of affordability (cheaper is better), performance, compliance/control, and ease of operations, using scenario weights above.
              </div>
            </div>
          )}
        </div>

        {/* Actions */}
        <div className="flex flex-col items-center gap-3">
          {!evaluated && selected && (
            <button
              onClick={handleEvaluate}
              className="bg-gradient-to-r from-green-600 to-emerald-600 text-white px-6 py-3 rounded-lg font-bold hover:from-green-700 hover:to-emerald-700 transition shadow-lg hover:shadow-xl"
            >
              Evaluate my choice
            </button>
          )}

          {evaluated && selected && (
            <div className="w-full bg-slate-900/50 rounded-xl p-4 border border-slate-700">
              {/* Feedback logic */}
              <div className="text-slate-200 text-lg mb-1">
                {selected.metrics.fit === topFit.metrics.fit
                  ? "‚úÖ Excellent ‚Äî you chose the top‚Äëranked option for this scenario."
                  : allCombos.findIndex((c) => c.service === selected.service && c.deployment === selected.deployment) <= 2
                  ? "üëç Solid ‚Äî your pick is among the top three for this scenario."
                  : "üí° Reasonable, but there are options that fit better for this scenario."}
              </div>
              <div className="text-slate-300 text-sm">
                Your Fit Score: <b className="text-emerald-300">{selected.metrics.fit}/100</b>. Top option:{" "}
                <b className="text-emerald-300">
                  {SERVICE_META[topFit.service].label} + {DEPLOYMENT_META[topFit.deployment].label} ({topFit.metrics.fit}/100)
                </b>.
              </div>
              <div className="mt-2 text-slate-400 text-sm">
                Factors helping your choice:{" "}
                <b>
                  {[
                    selected.metrics.performance >= 80 ? "performance" : null,
                    selected.metrics.compliance >= 80 ? "compliance" : null,
                    selected.metrics.ease >= 70 ? "low ops effort" : null,
                  ]
                    .filter(Boolean)
                    .join(", ") || "none highlighted"}
                </b>
                . Factors hurting your choice:{" "}
                <b>
                  {[
                    selected.metrics.performance < 60 ? "performance" : null,
                    selected.metrics.compliance < 60 ? "compliance" : null,
                    selected.metrics.ease < 50 ? "ops effort" : null,
                  ]
                    .filter(Boolean)
                    .join(", ") || "none highlighted"}
                </b>
                .
              </div>
            </div>
          )}

          {evaluated && (
            <button
              onClick={handleNext}
              className="bg-gradient-to-r from-purple-600 to-indigo-600 text-white px-6 py-3 rounded-lg font-bold hover:from-purple-700 hover:to-indigo-700 transition shadow-lg hover:shadow-xl"
            >
              {scenarioIdx < SCENARIOS.length - 1 ? "Next scenario" : "Finish"}
            </button>
          )}
        </div>

        {/* Footer helper */}
        <div className="mt-6 text-xs text-slate-500">
          Tip for teachers: Encourage learners to toggle ‚ÄúCompare‚Äëall‚Äù and move the user slider to see how rankings
          change as scale grows. Ask: ‚ÄúWhen would you pick Hybrid over Public? Why is SaaS ideal for internal CRM?‚Äù
        </div>
      </div>
    </div>
  );
}
